name: ðŸ–¥ï¸ Persistent VPS with Pterodactyl Panel

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 330
    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ’¾ Restore vm_data
        run: |
          if git show-ref --verify --quiet refs/heads/vm-data; then
            git fetch origin vm-data
            git checkout vm-data -- vm_data || echo "No vm_data found"
          else
            echo "No vm-data branch found"
          fi
          mkdir -p vm_data/panel vm_data/wings

      - name: âš™ï¸ Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y nginx mariadb-server redis-server curl php php-cli php-fpm php-mysql php-zip php-gd php-mbstring php-curl php-xml composer unzip git jq
          sudo systemctl enable nginx mariadb redis-server
          sudo systemctl start nginx mariadb redis-server

      - name: ðŸ”„ Restore Pterodactyl files
        run: |
          if [ -d "vm_data/panel" ] && [ "$(ls -A vm_data/panel)" ]; then
            sudo mkdir -p /var/www/pterodactyl
            sudo cp -r vm_data/panel/* /var/www/pterodactyl/
            echo "âœ… Restored Pterodactyl panel files"
          fi

          if [ -d "vm_data/wings" ] && [ "$(ls -A vm_data/wings)" ]; then
            sudo mkdir -p /etc/pterodactyl /var/lib/pterodactyl
            sudo cp -r vm_data/wings/* /etc/pterodactyl/ || true
            echo "âœ… Restored Wings files"
          fi

      - name: ðŸ§  Start SSHX
        run: |
          curl -fsSL https://sshx.io/get | sh
          echo "âœ… SSHX started! You can access it from the above link."

      - name: ðŸš€ Start Pterodactyl Panel and Wings
        run: |
          if [ -d "/var/www/pterodactyl" ] && [ -f "/var/www/pterodactyl/artisan" ]; then
            echo "ðŸ–¥ï¸ Starting Pterodactyl Panel..."
            cd /var/www/pterodactyl

            sudo chown -R www-data:www-data /var/www/pterodactyl
            sudo chmod -R 755 /var/www/pterodactyl

            # Configure Nginx for port 80
            sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOL
server {
    listen 80;
    server_name _;
    root /var/www/pterodactyl/public;

    index index.php;
    access_log /var/log/nginx/pterodactyl.access.log;
    error_log /var/log/nginx/pterodactyl.error.log;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php\$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php$(php -r 'echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;')-fpm.sock;
        fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOL

            sudo ln -sf /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/pterodactyl.conf
            sudo nginx -t && sudo systemctl restart nginx
            sudo systemctl restart php*-fpm || true

            sudo php artisan queue:work --daemon &
            echo "âœ… Panel started on port 80"
          else
            echo "âš ï¸ Pterodactyl not installed â€” skipping panel startup"
          fi

          if [ -d "/etc/pterodactyl" ]; then
            echo "ðŸš€ Starting Wings..."
            sudo wings &
          else
            echo "âš ï¸ Wings not found â€” skipping startup"
          fi

      - name: ðŸ’¾ Auto Backup every 10s
        run: |
          while true; do
            echo "ðŸ•’ Backing up Pterodactyl panel and wings..."
            sudo rm -rf vm_data/panel/* vm_data/wings/*
            sudo mkdir -p vm_data/panel vm_data/wings

            sudo cp -r /var/www/pterodactyl/* vm_data/panel/ 2>/dev/null || true
            sudo cp -r /etc/pterodactyl/* vm_data/wings/ 2>/dev/null || true

            git config user.email "actions@github.com"
            git config user.name "GitHub Actions"
            git add vm_data
            git commit -m "ðŸ•’ Auto-backup $(date)" || true
            git push origin HEAD:vm-data --force || true
            sleep 10
          done
