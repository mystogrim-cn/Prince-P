name: Persistent Ubuntu VPS (Pterodactyl Auto-Restart)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 330

    steps:
      - name: ğŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§© Setup persistent VM data
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git rsync curl unzip

          # Restore previous /var backup if available
          if [ -d "vm_data/var" ]; then
            echo "â™»ï¸ Restoring /var from backup..."
            sudo rsync -a vm_data/var/ /var/
          else
            echo "âš ï¸ No previous /var backup found, starting clean."
          fi

      - name: ğŸ§± Check and Start Pterodactyl Panel + Wings
        run: |
          echo "ğŸ” Checking for Pterodactyl installation..."

          # Check for panel
          if [ -d "/var/www/pterodactyl" ]; then
            echo "âœ… Pterodactyl Panel found, starting services..."
            cd /var/www/pterodactyl
            php artisan serve --host=0.0.0.0 --port=80 &
          else
            echo "âš ï¸ Pterodactyl Panel not found â€” skipping startup."
          fi

          # Check for Wings
          if command -v docker >/dev/null 2>&1 && [ -f "/etc/pterodactyl/config.yml" ]; then
            echo "âœ… Wings config found â€” starting Wings daemon..."
            sudo systemctl daemon-reexec || true
            sudo systemctl restart docker || true
            sudo wings --config /etc/pterodactyl/config.yml &
          else
            echo "âš ï¸ Wings not found or not configured â€” skipping startup."
          fi

          echo "ğŸš€ Startup process complete."

      - name: ğŸ” Auto-backup /var every 10 seconds
        run: |
          while true; do
            echo "ğŸ•’ Creating fresh backup of /var..."
            cd /home/runner/work/${{ github.repository }}/

            # Delete old and replace with new backup
            rm -rf vm_data/var
            mkdir -p vm_data
            sudo rsync -a --delete /var vm_data/

            # Git push new backup
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add vm_data
            git commit -m "ğŸ’¾ Auto backup of /var at $(date)" || true
            git push -f origin vm-data

            echo "âœ… Backup updated at $(date)"
            sleep 10
          done &
          sleep infinity
