name: Persistent Ubuntu VPS (Pterodactyl Auto-Restart)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 330

    steps:
      - name: 🧱 Checkout repository
        uses: actions/checkout@v4

      - name: 🧩 Setup persistent VM data
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git rsync curl unzip

          # Restore previous /var backup if available
          if [ -d "vm_data/var" ]; then
            echo "♻️ Restoring /var from backup..."
            sudo rsync -a vm_data/var/ /var/
          else
            echo "⚠️ No previous /var backup found, starting clean."
          fi

      - name: 🧱 Check and Start Pterodactyl Panel + Wings
        run: |
          echo "🔍 Checking for Pterodactyl installation..."

          # Check for panel
          if [ -d "/var/www/pterodactyl" ]; then
            echo "✅ Pterodactyl Panel found, starting services..."
            cd /var/www/pterodactyl
            php artisan serve --host=0.0.0.0 --port=80 &
          else
            echo "⚠️ Pterodactyl Panel not found — skipping startup."
          fi

          # Check for Wings
          if command -v docker >/dev/null 2>&1 && [ -f "/etc/pterodactyl/config.yml" ]; then
            echo "✅ Wings config found — starting Wings daemon..."
            sudo systemctl daemon-reexec || true
            sudo systemctl restart docker || true
            sudo wings --config /etc/pterodactyl/config.yml &
          else
            echo "⚠️ Wings not found or not configured — skipping startup."
          fi

          echo "🚀 Startup process complete."

      - name: 🔁 Auto-backup /var every 10 seconds
        run: |
          while true; do
            echo "🕒 Creating fresh backup of /var..."
            cd /home/runner/work/${{ github.repository }}/

            # Delete old and replace with new backup
            rm -rf vm_data/var
            mkdir -p vm_data
            sudo rsync -a --delete /var vm_data/

            # Git push new backup
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add vm_data
            git commit -m "💾 Auto backup of /var at $(date)" || true
            git push -f origin vm-data

            echo "✅ Backup updated at $(date)"
            sleep 10
          done &
          sleep infinity
